<div class="container mt-4">
  <h1 class="text-center">Quản lý quyền người dùng</h1>
  <div class="mb-3 d-flex justify-content-between">
    <%= search_form_for @q, url: role_manager_users_path, method: :get, html: { class: "d-flex" } do |f| %>
      <%= f.text_field :name_or_email_cont, class: "form-control me-2", placeholder: "Tìm kiếm tên hoặc email" %>
      <%= f.submit "Tìm kiếm", class: "btn btn-secondary me-2" %>
    <% end %>

    <!-- Nút lọc -->
    <div>
      <%= link_to "Lọc Admin", role_manager_users_path(q: { system_role_role_name_eq: "admin" }), class: "btn btn-primary me-2" %>
      <%= link_to "Lọc User", role_manager_users_path(q: { system_role_role_name_eq: "user" }), class: "btn btn-success" %>
      <%= link_to "Hiển thị tất cả", role_manager_users_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>
  <table class="table table-bordered table-hover">
    <thead>
    <tr>
      <th>Tên</th>
      <th>Email</th>
      <th>Quyền</th>
      <th>Hành động</th>
    </tr>
    </thead>
    <tbody id="user-table">
    <% @users.each do |user| %>
      <tr data-user-id="<%= user.id %>">
        <td><%= user.name %></td> <!-- Cột Tên -->
        <td><%= user.email %></td>
        <td>
          <select class="form-select role-select" data-user-id="<%= user.id %>">
            <% @roles.each do |role| %>
              <option value="<%= role.id %>" <%= "selected" if user.system_role_id == role.id %>>
                <%= role.role_name.titleize %>
              </option>
            <% end %>
          </select>
        </td>
        <td>
          <button class="btn btn-danger btn-sm delete-user">Xóa</button>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>

  <nav>
    <%= paginate @users %>
  </nav>
</div>

<script>
    $(document).ready(function () {
        // Xử lý sự kiện thay đổi quyền
        $(document).on("change", ".role-select", function () {
            const userId = $(this).data("user-id");
            const roleId = $(this).val();
            console.log(`URL: /users/${userId}/update_role, role_id: ${roleId}`);
            $.ajax({
                url: `/users/${userId}/update_role`,
                method: "POST",
                data: { role_id: roleId },
                success: function (response) {
                    alert(response.message);
                },
                error: function (xhr) {
                    alert("Không thể cập nhật quyền. Vui lòng thử lại.");
                },
            });
        });

        // Xử lý nút xóa người dùng (bổ sung nếu cần)
        $(document).on("click", ".delete-user", function () {
            const row = $(this).closest("tr"); // Lấy dòng chứa nút được nhấn
            const userId = row.data("user-id");

            if (confirm("Bạn có chắc chắn muốn xóa người dùng này không?")) {
                $.ajax({
                    url: `/users/${userId}`,
                    method: "DELETE",
                    success: function (response) {
                        alert(response.message); // Hiển thị thông báo thành công
                        row.fadeOut(300, function () {
                            $(this).remove(); // Loại bỏ dòng sau khi hiệu ứng mờ hoàn tất
                        });
                    },
                    error: function (xhr) {
                        alert("Không thể xóa người dùng. Vui lòng thử lại.");
                    },
                });
            }
        });
    });

</script>